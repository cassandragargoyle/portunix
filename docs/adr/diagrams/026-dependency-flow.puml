@startuml ADR-026 Dependency Flow
!theme plain
skinparam backgroundColor #FEFEFE
skinparam packageBackgroundColor<<shared>> #E5FFE5
skinparam packageBorderColor<<shared>> #00AA00
skinparam packageBackgroundColor<<binary>> #E5F0FF
skinparam packageBorderColor<<binary>> #0066CC
skinparam packageBackgroundColor<<helper>> #FFE5F0
skinparam packageBorderColor<<helper>> #CC0066

title ADR-026: Shared Platform Utilities\nDependency Flow and Package Structure

package "Go Runtime" as runtime {
    [runtime.GOOS]
    [runtime.GOARCH]
    [os.Geteuid()]
}

package "src/pkg/platform" <<shared>> {
    package "platform.go" {
        component "GetOS()" as getOS
        component "GetArchitecture()" as getArch
        component "GetPlatform()" as getPlatform
        component "IsWindows/Linux/Darwin()" as isOS
    }

    package "permissions.go" {
        component "IsRunningAsRoot()" as isRoot
        component "IsSudoAvailable()" as isSudo
        component "GetSudoPrefix()" as getSudoPrefix
        component "CanWriteToDirectory()" as canWrite
        component "IsUserDirectory()" as isUserDir
    }

    package "platform_test.go" {
        component "[12 Unit Tests]" as tests
    }
}

package "Main Binary (portunix)" <<binary>> {
    component "Dispatcher" as dispatcher
    component "Commands" as commands

    package "app/install/" {
        component "config.go" as installConfig
        note right: Legacy code\nPhase 5: Migrate to platform pkg
    }
}

package "Helper: ptx-installer" <<helper>> {
    package "engine/" {
        component "platform.go" as enginePlatform {
            GetOperatingSystem()
            GetArchitecture()
            IsRunningAsRoot()
            IsSudoAvailable()
            --
            Wrapper functions
            for backward compatibility
        }
        component "installer.go" as installer
        component "download.go" as download
    }

    package "registry/" {
        component "registry.go" as registry
    }
}

package "Future Helpers" <<helper>> {
    component "ptx-python" as python
    component "ptx-container" as container
    component "ptx-virt" as virt
}

' Runtime dependencies
getOS --> [runtime.GOOS] : uses
getArch --> [runtime.GOARCH] : uses
isRoot --> [os.Geteuid()] : uses

' Test dependencies
tests --> getOS : tests
tests --> getArch : tests
tests --> getPlatform : tests
tests --> isRoot : tests
tests --> isSudo : tests

' Wrapper usage
enginePlatform ..> getOS : delegates
enginePlatform ..> getArch : delegates
enginePlatform ..> isRoot : delegates
enginePlatform ..> isSudo : delegates
enginePlatform ..> getSudoPrefix : delegates

' Binary usage
installer --> enginePlatform : uses
download --> enginePlatform : uses
registry --> enginePlatform : uses

' Future usage
python .[#green,dotted].> getOS : future
python .[#green,dotted].> getArch : future
container .[#green,dotted].> getOS : future
virt .[#green,dotted].> getSudoPrefix : future

' Legacy
installConfig .[#red,dashed].> getArch : should migrate

note right of runtime
    **Go Standard Library**
    Cross-platform abstractions
    No external dependencies
end note

note bottom of "src/pkg/platform"
    **Shared Package Benefits:**
    ✓ Single source of truth
    ✓ No code duplication
    ✓ Comprehensive tests
    ✓ Easy to import
    ✓ Backward compatible
end note

note right of enginePlatform
    **Backward Compatibility:**
    Existing code continues to work
    using wrapper functions

    Original function names preserved:
    - GetOperatingSystem() → GetOS()
    - DetermineSudoPrefix() → GetSudoPrefix()
end note

legend right
    |<#E5FFE5> Shared Package |
    |<#E5F0FF> Main Binary |
    |<#FFE5F0> Helper Binaries |
    |<#red> Should Migrate |
    |<#green> Future Use |
    | → | Direct dependency |
    | ..> | Delegates/Uses |
endlegend

@enduml
